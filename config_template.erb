# ---------------------------------------------------
# This config file is generated by nginx-config-api.
# https://github.com/namazu510/nginx-config-api
# ---------------------------------------------------
server {
  server_name <%= domain.domain %>;
  include "includes/lets-http.conf";
}

server {
  # basic setting
  server_name	<%= domain.domain %>;

  # access log
  <% if CONFIG.nginx.app_log %>
  access_log /var/log/nginx/<%= domain.domain %>/access.log;
  error_log  /var/log/nginx/<%= domain.domain %>/error.log;
  <% else %>
  access_log off;
  error_log off;
  <% end %>

  <% unless CONFIG.nginx.ssl %>
  listen 80;
  <% end %>

  <% if use_lets %>
  # SSL setting
  include "includes/lets.conf";
  ssl_trusted_certificate <%= domain.lets_live_path %>/fullchain.pem;
  ssl_certificate         <%= domain.lets_live_path %>/fullchain.pem;
  ssl_certificate_key     <%= domain.lets_live_path %>/privkey.pem;
  <% end %>

  <% if dummy_ssl %>
  # SSL setting
  listen 443;
  ssl on;
  ssl_certificate     /etc/pki/tls/certs/server.crt;
  ssl_certificate_key /etc/pki/tls/private/server.key;
  <% end %>

  <% if domain.use_auth %>
  # Auth setting
  location <%= auth_uri.path %> {
    internal;

    proxy_set_header X-Request-Url $scheme://$host$request_uri;
    proxy_set_header Content-Length "";
    proxy_pass_request_body off;
    proxy_pass <%= auth_uri.to_s %>;
  }

  location @auth_redirect {
    internal;
    return 302 $x_auth_url;
  }

  location /auth/gallery-token-login {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_pass http://gallery-portal.gallery.local;
  }
  <% end %>

  # Reverse Proxy
  location / {
    <% if domain.use_auth %>
    # Auth request
    auth_request <%= auth_uri.path %>;
    auth_request_set $x_auth_url $upstream_http_x_auth_url;
    error_page 401 = @auth_redirect;
    <% end %>

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_pass <%= domain.proxy_pass %>;
  }
}
