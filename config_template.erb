# ---------------------------------------------------
# This config file is generated by nginx-config-api.
# https://github.com/uutarou10/nginx-config-api
# ---------------------------------------------------
server {
	# basic setting
  server_name	<%= domain.domain %>;

	# access log
	<% if CONFIG[ENV]['nginx']['app_log'] %>
	access_log /var/log/nginx/<%= domain.domain %>/access.log;
	error_log  /var/log/nginx/<%= domain.domain %>/error.log;
	<% else %>
	access_log off;
	error_log off;
	<% end %>

	<% unless CONFIG[ENV]['nginx']['ssl'] %>
	listen 80;
	<% end %>

	<% if use_lets %>
	# SSL setting
  include "includes/lets.conf";
	ssl_trusted_certificate <%= cert_files[:live][:path].to_s %>/fullchain.pem;
	ssl_certificate         <%= cert_files[:live][:path].to_s %>/fullchain.pem;
	ssl_certificate_key     <%= cert_files[:live][:path].to_s %>/privkey.pem;
	<% end %>

	<% if dummy_ssl %>
	# SSL setting
	listen 443;
	ssl on;
	ssl_certificate     /etc/pki/tls/certs/server.crt;
	ssl_certificate_key /etc/pki/tls/private/server.key;
	<% end %>

	<% if use_auth %>
	# Auth setting
	auth_request <%= auth_uri.path %>;
	location <%= auth_uri.path %> {
		internal;
		proxy_pass <%= auth_uri.to_s %>;
	}
	<% end %>

	include "includes/header.conf";
	# Reverse Proxy
	location / {
    # auth_tktがパラメータで渡ってくる場合の対処
    if ($arg_auth_tkt) {
      add_header Set-Cookie "auth_tkt=$arg_auth_tkt; domain=<%= domain.domain %>; max-age=360000; Secure";
      # クエリを取り除いてリダイレクトを発行する
      return 302 $scheme://$host$uri;
    }
  	proxy_pass <%= domain.proxy_pass %>;
	}
}
