# ---------------------------------------------------
# This config file is generated by nginx-config-api.
# https://github.com/namazu510/nginx-config-api
# ---------------------------------------------------
server {
  server_name <%= domain.domain %>;
  include "includes/lets-http.conf";
}

server {
  # basic setting
  server_name	<%= domain.domain %>;

  # access log
  <% if CONFIG[ENV]['nginx']['app_log'] %>
  access_log /var/log/nginx/<%= domain.domain %>/access.log;
  error_log  /var/log/nginx/<%= domain.domain %>/error.log;
  <% else %>
  access_log off;
  error_log off;
  <% end %>

  <% unless CONFIG[ENV]['nginx']['ssl'] %>
  listen 80;
  <% end %>

  <% if use_lets %>
  # SSL setting
  include "includes/lets.conf";
  ssl_trusted_certificate <%= cert_files[:live][:path].to_s %>/fullchain.pem;
  ssl_certificate         <%= cert_files[:live][:path].to_s %>/fullchain.pem;
  ssl_certificate_key     <%= cert_files[:live][:path].to_s %>/privkey.pem;
  <% end %>

  <% if dummy_ssl %>
  # SSL setting
  listen 443;
  ssl on;
  ssl_certificate     /etc/pki/tls/certs/server.crt;
  ssl_certificate_key /etc/pki/tls/private/server.key;
  <% end %>

  # Reverse Proxy
  location / {
    # auth_tktがパラメータで渡ってくる場合の対処
    if ($arg_auth_tkt) {
      add_header Set-Cookie "auth_tkt=$arg_auth_tkt; domain=<%= domain.domain %>; max-age=360000; Secure";
      # クエリを取り除いてリダイレクトを発行する
      return 302 $scheme://$host$uri;
    }
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    proxy_pass http://localhost:10080;
    proxy_redirect http:// https://;
  }
}

# 2段構成
# http://namazu-tech.hatenablog.com/entry/2018/01/25/232629
server {
  server_name	<%= domain.domain %>;
  listen 10080;

  <% if domain.use_auth %>
  # Auth setting
  auth_request <%= auth_uri.path %>;
  auth_request_set $x_auth_url $upstream_http_x_auth_url;
  error_page 401 = @auth_redirect;

  location <%= auth_uri.path %> {
    internal;

    proxy_set_header X-Request-Url $scheme://$host$request_uri;
    proxy_pass_request_body off;
    proxy_pass <%= auth_uri.to_s %>;
  }

  location @auth_redirect {
    internal;
    return 302 $x_auth_url;
  }
  <% end %>

  # Reverse Proxy
  location / {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Server $host;

  	proxy_pass <%= domain.proxy_pass %>;
  }
}
